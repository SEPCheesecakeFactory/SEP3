@page "/admin-panel"
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Services
@using BlazorApp.Entities
@using BlazorApp.Utils
@using BlazorApp.Components
@using System.Security.Claims

@inject NavigationManager navMgr
@inject AuthenticationStateProvider AuthProvider
@inject IUserService UserService
@inject ICourseService CourseService

<div class="container-fluid mt-4 content-wrapper mx-auto" style="max-width: 1200px;">

    <div class="d-flex justify-content-between align-items-end mb-4 fade-in">
        <div>
            <h2 class="fw-bolder text-secondary mb-0">Admin Panel</h2>
            <p class="text-muted small mb-0 fw-bold text-uppercase" style="letter-spacing: 1px;">
                Manage Settings & Data
            </p>
        </div>
    </div>

    <AuthorizeView Roles="admin">
        <Authorized>

            @if (isLoading)
            {
                <div class="d-flex justify-content-center align-items-center" style="height: 40vh;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else if (loadError)
            {
                <div class="alert bg-red-100 text-red-600 border-red-200 border-2 rounded-3 fw-bold fade-in">
                    <i class="fas fa-exclamation-triangle me-2"></i> Connection Error: Could not load data.
                    <button class="btn btn-sm btn-outline-danger ms-3" @onclick="LoadData">Retry</button>
                </div>
            }
            else
            {
                <AdminSection Title="Course Categories" Icon="fa-folder" IconColorClass="text-primary"
                    @bind-IsExpanded="isCategoriesExpanded">

                    <div class="p-4 border-2 border-dashed rounded-4 mb-4" style="border-color: var(--gray);">
                        <h6 class="fw-bold text-secondary text-uppercase mb-3 small" style="letter-spacing: 0.5px;">
                            <i class="fas fa-plus-circle me-1"></i> Create New Category
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control game-input" placeholder="Category Name"
                                    @bind="newCategoryName" />
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control game-input" placeholder="Description"
                                    @bind="newCategoryDescription" />
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary fw-bold w-100 shadow-sm-hover"
                                    @onclick="CreateCategory">Create</button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        @foreach (var category in categories)
                        {
                            <div class="col-md-4">
                                <div class="p-3 border rounded-3 h-100 bg-white">
                                    <h6 class="fw-bold text-dark mb-1">@category.Name</h6>
                                    <p class="text-muted small mb-0 text-truncate">@category.Descritpion</p>
                                </div>
                            </div>
                        }
                    </div>
                </AdminSection>

                <AdminSection Title="Languages" Icon="fa-globe" IconColorClass="text-success"
                    @bind-IsExpanded="isLanguagesExpanded">

                    <div class="p-4 border-2 border-dashed rounded-4 mb-4" style="border-color: var(--gray);">
                        <h6 class="fw-bold text-secondary text-uppercase mb-3 small" style="letter-spacing: 0.5px;">
                            <i class="fas fa-plus-circle me-1"></i> Add New Language
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control game-input" placeholder="Code (e.g ENG)"
                                    maxlength="3" @bind="newLangCode" />
                            </div>
                            <div class="col-md-7">
                                <input type="text" class="form-control game-input" placeholder="Language Name"
                                    @bind="newLangName" />
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary fw-bold w-100 shadow-sm-hover"
                                    @onclick="CreateLanguage">Add</button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        @foreach (var lang in languages)
                        {
                            <div class="col-6 col-md-3">
                                <div class="p-3 border rounded-3 h-100 bg-white">
                                    <h6 class="fw-bold text-dark mb-1">@lang.Name</h6>
                                    <span class="badge bg-light text-secondary border fw-bold">@lang.Code</span>
                                </div>
                            </div>
                        }
                    </div>
                </AdminSection>

                <AdminSection Title="Registered Users" Icon="fa-users" IconColorClass="text-warning"
                    @bind-IsExpanded="isUsersExpanded">

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <input type="text" class="form-control game-input" placeholder="Filter by Username..."
                                @bind="usernameFilter" @bind:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control game-input" placeholder="Filter by ID..."
                                @bind="idFilter" @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-3">
                        @foreach (var user in FilteredUsers)
                        {
                            <div class="p-3 border rounded-3 bg-white shadow-sm-hover" style="cursor:pointer;"
                                @onclick="() => ToggleUser(user.Id)">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-muted border me-3">#@user.Id</span>
                                        <span class="fw-bolder text-dark fs-5 me-2">@user.Username</span>

                                        @if (user.IsAdmin())
                                        {
                                            <span class="badge bg-red-100 text-red-600 border-red-200 ms-1">ADMIN</span>
                                        }

                                        @if (user.IsTeacher())
                                        {
                                            <span class="badge bg-purple-100 text-purple-600 border-purple-200 ms-1">TEACHER</span>
                                        }
                                    </div>
                                    <i
                                        class="fas fa-chevron-down text-muted transition-icon @(expandedUserIds.Contains(user.Id) ? "rotate-180" : "")"></i>
                                </div>

                                @if (expandedUserIds.Contains(user.Id))
                                {
                                    <div class="mt-3 pt-3 border-top d-flex justify-content-end gap-2"
                                        style="border-color: var(--gray) !important;">

                                        <button
                                            class="btn btn-sm fw-bold text-uppercase @(user.IsTeacher() ? "btn-danger" : "btn-outline-secondary")"
                                            @onclick:stopPropagation="true" @onclick="() => ToggleTeacherRole(user.Id)">
                                            @if (user.IsTeacher())
                                            {
                                                <span><i class="fas fa-times me-2"></i>Remove Teacher</span>
                                            }
                                            else
                                            {

                                                <span><i class="fas fa-chalkboard-teacher me-2"></i>Make Teacher</span>
                                            }
                                        </button>

                                        <button
                                            class="btn btn-sm fw-bold text-uppercase @(user.IsAdmin() ? "btn-danger" : "btn-outline-secondary")"
                                            @onclick:stopPropagation="true" @onclick="() => ToggleAdminRole(user.Id)">
                                            @if (user.IsAdmin())
                                            {
                                                <span><i class="fas fa-times me-2"></i>Remove Admin</span>
                                            }
                                            else
                                            {

                                                <span><i class="fas fa-user-shield me-2"></i>Make Admin</span>
                                            }
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </AdminSection>
            }
        </Authorized>
        <NotAuthorized>
            <AccessDeniedState Title="Access Denied" Message="You do not have permission to view the admin panel."
                Icon="fa-user-shield" />
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private bool isCategoriesExpanded = false;
    private bool isUsersExpanded = false;
    private bool isLanguagesExpanded = false;

    private int currentUserId = 0;
    private bool isLoading = true;
    private bool loadError = false;

    private List<User> users = new List<User>();
    private HashSet<int> expandedUserIds = new HashSet<int>();
    private string usernameFilter = "";
    private int? idFilter;

    private List<CourseCategory> categories = new List<CourseCategory>();
    private string newCategoryName = "";
    private string newCategoryDescription = "";

    private List<Language> languages = new List<Language>();
    private string newLangCode = "";
    private string newLangName = "";

    private IEnumerable<User> FilteredUsers => users.Where(u =>
    (string.IsNullOrEmpty(usernameFilter) || u.Username.Contains(usernameFilter, StringComparison.OrdinalIgnoreCase)) &&
    (!idFilter.HasValue || u.Id == idFilter.Value)
    );

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        loadError = false;
        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            currentUserId = user.GetID() ?? 0;

            var usersTask = UserService.GetUsers();
            var categoriesTask = CourseService.GetCategories();
            var languagesTask = CourseService.GetLanguages();

            await Task.WhenAll(usersTask, categoriesTask, languagesTask);

            users = usersTask.Result;
            categories = categoriesTask.Result;
            languages = languagesTask.Result;
        }
        catch (Exception)
        {
            loadError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CreateCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategoryName)) return;
        try
        {
            await CourseService.CreateCategory(new CreateCourseCategoryDto
            {
                Name = newCategoryName,
                Descritpion = newCategoryDescription
            });
            categories = await CourseService.GetCategories();
            newCategoryName = ""; newCategoryDescription = "";
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private async Task CreateLanguage()
    {
        if (string.IsNullOrWhiteSpace(newLangCode) || string.IsNullOrWhiteSpace(newLangName)) return;
        try
        {
            await CourseService.CreateLanguage(new CreateLanguageDto { Code = newLangCode.ToUpper(), Name = newLangName });
            languages = await CourseService.GetLanguages();
            newLangCode = ""; newLangName = "";
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private void ToggleUser(int userId)
    {
        if (expandedUserIds.Contains(userId)) expandedUserIds.Remove(userId);
        else expandedUserIds.Add(userId);
    }

    private async Task ToggleTeacherRole(int userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user == null) return;

        if (user.IsTeacher())
        {
            var role = user.Roles.FirstOrDefault(r => r.RoleName == "teacher");
            if (role != null) user.Roles.Remove(role);
        }
        else
        {
            user.Roles.Add(new Role { RoleName = "teacher" });
        }

        try { await UserService.UpdateUser(user.Id, user); }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private async Task ToggleAdminRole(int userId)
    {
        var user = users.FirstOrDefault(u => u.Id == userId);
        if (user == null) return;

        if (user.IsAdmin())
        {
            var role = user.Roles.FirstOrDefault(r => r.RoleName == "admin");
            if (role != null) user.Roles.Remove(role);
        }
        else
        {
            user.Roles.Add(new Role { RoleName = "admin" });
        }

        try { await UserService.UpdateUser(user.Id, user); }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }
}