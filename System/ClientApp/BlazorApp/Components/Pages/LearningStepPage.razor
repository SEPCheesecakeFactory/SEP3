@page "/courses/{CourseId:int}/steps/{StepOrder:int}"
@using BlazorApp.Services
@using BlazorApp.Entities
@using System.Text.Json
@inject ILearningStepService StepService
@inject NavigationManager NavManager

<PageTitle>Learning Step @StepOrder</PageTitle>

@if (currentStep == null || isLoading || wasError)
{
    <LoadingSpinner />
    <div class="d-flex justify-content-between border-top pt-4 mt-4 mb-5">
        <button class="btn btn-outline-secondary px-4 py-3 border-2" @onclick="GoPrevious" disabled="@(StepOrder <= 1)">
            PREVIOUS
        </button>
    </div>
}
else
{
    <div class="d-flex flex-column h-100 mx-auto" style="max-width: 800px;">

        <div class="d-flex align-items-center mb-5 pt-2">
            <a href="/" class="btn btn-link text-secondary p-0 me-4">
                <i class="fas fa-times fa-2x"></i>
            </a>

            <div class="progress w-100" style="height: 16px;">
                <div class="progress-bar" style="width: @(StepOrder * 10)%"></div>
            </div>
        </div>

        <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center">

            <div class="mb-5 d-flex align-items-center justify-content-between gap-3">
                <h2 class="fw-bolder text-dark fs-1 mb-0">@($"Step {StepOrder}")</h2>

                <AuthorizeView Context="authState">
                    <Authorized>
                        @if (ConvertFromClaim(authState.User.Claims.Single(c => c.Type ==
                                            "Role").Value).Contains("teacher"))
                        {
                            <button class="btn btn-outline-secondary btn-sm px-2 py-1 ms-3" @onclick="GoToEditStep">
                                EDIT STEP
                            </button>
                        }
                    </Authorized>
                </AuthorizeView>
            </div>

            @if (IsMultipleChoiceQuestion)
            {
                <div class="card w-100 border-2 rounded-4 p-4 shadow-sm">
                    <h4 class="fw-bold mb-4 text-center">@McQuestion</h4>

                    @foreach (var option in ShuffledOptions)
                    {
                        <button class="btn btn-outline-success w-100 mb-3" @onclick="() => SelectMcOption(option)">
                            @option
                        </button>
                    }

                    @if (McAnswered)
                    {
                        <div class="alert @(McCorrect ? "alert-success" : "alert-danger") text-center mt-3">
                            @(McCorrect ? "Correct!" : "Incorrect!")
                        </div>
                    }
                </div>
            }
            else if (IsFillBlankQuestion)
            {
                <div class="card w-100 border-2 rounded-4 p-4 shadow-sm text-center">
                    <h4 class="fw-bold mb-4">@FillQuestion</h4>

                    <input class="form-control form-control-lg mb-3" @bind="FillAnswer" placeholder="Type your answer..." />

                    @if (!CanContinue)
                    {
                        <button class="btn btn-primary px-4" @onclick="CheckFillAnswer">
                            SUBMIT
                        </button>
                    }

                    @if (FillAnswered)
                    {
                        <div class="alert @(FillCorrect ? "alert-success" : "alert-danger") text-center mt-3">
                            @(FillCorrect ? "Correct!" : "Try again!")
                        </div>
                    }
                </div>
            }
            else if (string.Equals(currentStep?.Type, "image", StringComparison.OrdinalIgnoreCase))
            {
                <div class="w-100 text-center mb-4">
                    <img src="@currentStep!.Content!" class="img-fluid rounded-4 border border-2" alt="visual"
                        style="max-height:400px;">
                </div>
            }
            else if (currentStep?.Content?.Contains("youtube.com") == true ||
            currentStep?.Content?.Contains("youtu.be") == true)
            {
                <div class="ratio ratio-16x9 mb-4 rounded-4 overflow-hidden border border-2">
                    <iframe src="@GetYouTubeEmbedUrl(currentStep!.Content!)" frameborder="0" allowfullscreen
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            }
            else
            {
                <div class="card w-100 border-2 rounded-4 p-5 text-center shadow-sm">
                    <p class="fs-3 text-secondary mb-0 lh-base">
                        @(currentStep?.Content ?? "")
                    </p>
                </div>
            }
        </div>

        <div class="d-flex justify-content-between border-top pt-4 mt-4 mb-5">
            <button class="btn btn-outline-secondary px-4 py-3 border-2" @onclick="GoPrevious" disabled="@(StepOrder <= 1)">
                PREVIOUS
            </button>

            @if (CanContinue)
            {
                <button class="btn btn-primary px-5 py-3 text-white" @onclick="GoNext">
                    NEXT
                </button>
            }

        </div>
    </div>
}

@code {
    [Parameter] public int CourseId { get; set; }
    [Parameter] public int StepOrder { get; set; }

    private LearningStep? currentStep;

    private bool IsMultipleChoiceQuestion => currentStep?.Type == "QuestionMC";
    private bool IsFillBlankQuestion => currentStep?.Type == "QuestionFILL";
    private bool IsQuestion => IsMultipleChoiceQuestion || IsFillBlankQuestion;

    private string McQuestion = "";
    private List<string> ShuffledOptions = new();
    private string CorrectMcAnswer = "";
    private bool McAnswered = false;
    private bool McCorrect = false;

    private string FillQuestion = "";
    private string FillCorrectAnswer = "";
    private string FillAnswer = "";
    private bool FillAnswered = false;
    private bool FillCorrect = false;

    private bool isLoading = true;
    private bool wasError = false;

    private bool CanContinue => !IsQuestion || (McCorrect || FillCorrect);

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        wasError = false;
        try
        {
            currentStep = await StepService.GetLearningStepAsync(CourseId, StepOrder);
            if (currentStep?.Content != null)
            {
                ParseQuestion(currentStep.Content);
            }
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error fetching step: {ex.Message}");
            wasError = true;
            isLoading = false;
        }
    }

    private void ParseQuestion(string content)
    {
        // Reset the state logic for the new step
        McAnswered = false;
        McCorrect = false;
        FillAnswered = false;
        FillCorrect = false;
        FillAnswer = string.Empty; // Clear the previous text input

        if (IsMultipleChoiceQuestion)
        {
            var parts = content.Split('|');
            McQuestion = parts[0];
            CorrectMcAnswer = parts[1];
            // Re-shuffle for the new question
            ShuffledOptions = parts.Skip(1).OrderBy(x => Guid.NewGuid()).ToList();
        }
        else if (IsFillBlankQuestion)
        {
            var parts = content.Split('|');
            FillQuestion = parts[0];
            FillCorrectAnswer = parts[1];
        }
    }

    private void SelectMcOption(string option)
    {
        McAnswered = true;
        McCorrect = option == CorrectMcAnswer;
    }

    private void CheckFillAnswer()
    {
        FillAnswered = true;
        FillCorrect = string.Equals(
        FillAnswer.Trim(),
        FillCorrectAnswer.Trim(),
        StringComparison.OrdinalIgnoreCase
        );
    }

    private void GoPrevious()
    {
        if (StepOrder > 1)
        {
            NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder - 1}");
        }
    }

    private void GoNext()
    {
        NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder + 1}");
    }

    private string GetYouTubeEmbedUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return "";

        if (url.Contains("watch?v="))
        {
            return url.Replace("watch?v=", "embed/");
        }

        if (url.Contains("youtu.be"))
        {
            var id = url.Split('/').Last();
            return $"https://www.youtube.com/embed/{id}";
        }

        return url;
    }

    private IEnumerable<string> ConvertFromClaim(string jsonInput)
    {
        List<string>? resultList = JsonSerializer.Deserialize<List<string>>(jsonInput);
        if (resultList != null)
        {
            return resultList;
        }
        else
        {
            return new List<string> { jsonInput };
        }
    }

    private void GoToEditStep()
    {
        NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder}/edit");
    }
}