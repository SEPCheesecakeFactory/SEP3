@page "/courses/{CourseId:int}/steps/{StepOrder:int}"
@using BlazorApp.Services
@using BlazorApp.Entities
@using BlazorApp.Utils
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using BlazorApp.Components 

@inject ILearningStepService StepService
@inject NavigationManager NavManager
@inject ICourseService CourseService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Learning View</PageTitle>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="container mt-5" style="max-width: 600px;">
        <div class="alert alert-danger text-center border-2 rounded-4 p-4 shadow-sm">
            <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
            <h4 class="fw-bold">Something went wrong</h4>
            <p>@errorMessage</p>
            <button class="btn btn-outline-danger mt-2" @onclick='() => NavManager.NavigateTo("/")'>
                Return Home
            </button>
        </div>
    </div>
}
else if (totalSteps == 0)
{
    @* EMPTY / PENDING STATE *@
    <div class="container mt-5" style="max-width: 700px;">
        <div class="text-center py-5 border-2 border-dashed rounded-4 bg-light fade-in" 
             style="border-color: var(--gray);">
            <div class="mb-3">
                <i class="fas fa-user-clock fa-4x text-muted opacity-50"></i>
            </div>
            <h2 class="fw-bold text-secondary mb-2">Under Review</h2>
            <p class="lead text-muted mb-4 px-4">
                This course content is currently <strong>waiting for approval</strong>. 
                Steps will appear here once the course is live.
            </p>
            <div class="d-flex justify-content-center">
                <button class="btn btn-outline-secondary fw-bold shadow-sm-hover" @onclick='() => NavManager.NavigateTo("all-courses")'>
                    <i class="fas fa-arrow-left me-2"></i> Back to Library
                </button>
            </div>
        </div>
    </div>
}
else if (currentStep != null)
{
    @* --- NORMAL LEARNING VIEW --- *@
    <div class="d-flex flex-column h-100 mx-auto" style="max-width: 800px;">
        
        <LearningStepHeader CurrentStep="@StepOrder"
                            TotalSteps="@totalSteps"
                            SavedProgress="@savedProgress"
                            ShowProgressText="true"
                            BottomMargin="5" />

        <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center">

            @* CHANGED: justify-content-center ensures the Title and Button are grouped 
               in the middle, rather than spread apart.
            *@
            <div class="mb-5 d-flex align-items-center justify-content-center gap-3 w-100">
                <h2 class="fw-bolder text-dark fs-1 mb-0">Step @StepOrder</h2>

                <AuthorizeView Context="authState">
                    <Authorized>
                        @if (authState.User.IsTeacher())
                        {
                            <button class="btn btn-outline-secondary btn-sm px-3 py-2 fw-bold text-uppercase"
                                    style="font-size: 0.8rem; letter-spacing: 1px;"
                                    @onclick="GoToEditStep">
                                <i class="fas fa-pen me-2"></i> Edit Step
                            </button>
                        }
                    </Authorized>
                </AuthorizeView>
            </div>

            @* CONTENT RENDERING *@
            @if (IsMultipleChoiceQuestion)
            {
                <div class="card w-100 border-2 rounded-4 p-4 shadow-sm">
                    <h4 class="fw-bold mb-4 text-center">@McQuestion</h4>
                    @foreach (var option in ShuffledOptions)
                    {
                        <button class="btn btn-outline-primary w-100 mb-3 text-start p-3 fw-bold"
                                @onclick="() => SelectMcOption(option)">
                            @option
                        </button>
                    }
                    @if (McAnswered)
                    {
                        <div class="alert @(McCorrect ? "alert-success" : "alert-danger") text-center mt-3 fw-bold">
                            @(McCorrect ? "Correct! ðŸŽ‰" : "Incorrect, try again.")
                        </div>
                    }
                </div>
            }
            else if (IsFillBlankQuestion)
            {
                <div class="card w-100 border-2 rounded-4 p-5 shadow-sm text-center">
                    <h4 class="fw-bold mb-4">@FillQuestion</h4>
                    <input class="form-control game-input form-control-lg mb-4 text-center"
                           @bind="FillAnswer"
                           placeholder="Type your answer..." />
                    
                    @if (!CanContinue)
                    {
                        <button class="btn btn-primary px-5 py-2 shadow-sm-hover" @onclick="CheckFillAnswer">
                            Check Answer
                        </button>
                    }
                    @if (FillAnswered)
                    {
                        <div class="alert @(FillCorrect ? "alert-success" : "alert-danger") text-center mt-4 fw-bold">
                            @(FillCorrect ? "Correct! ðŸŽ‰" : "Try again.")
                        </div>
                    }
                </div>
            }
            else if (currentStep?.Type == "Video")
            {
                <div class="ratio ratio-16x9 mb-4 rounded-4 overflow-hidden border border-2 shadow-sm">
                    <iframe src="@GetYouTubeEmbedUrl(currentStep!.Content!)"
                            frameborder="0"
                            allowfullscreen
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            }
            else
            {
                <div class="card w-100 border-2 rounded-4 p-5 text-center shadow-sm">
                    <p class="fs-4 text-secondary mb-0 lh-base">@(currentStep?.Content ?? "")</p>
                </div>
            }
        </div>

        <StepNavigationButtons CurrentStep="@StepOrder"
                               TotalSteps="@totalSteps"
                               IsEditMode="false"
                               CanContinue="@CanContinue"
                               OnPrevious="GoPrevious"
                               OnNext="GoNext"
                               OnFinish="FinishCourse" />
    </div>
}

@code {
    [Parameter] public int CourseId { get; set; }
    [Parameter] public int StepOrder { get; set; }

    [CascadingParameter] private Task<AuthenticationState>? AuthState { get; set; }

    private LearningStep? currentStep;
    private int savedProgress = 1;
    private int currentUserId = 0;
    private int totalSteps = 0; 
    private bool isLoading = true;
    private bool wasError = false;
    private string? errorMessage;

    // ... [Question Logic Variables] ...
    private bool IsMultipleChoiceQuestion => currentStep?.Type == "QuestionMC";
    private bool IsFillBlankQuestion => currentStep?.Type == "QuestionFILL";
    private bool IsQuestion => IsMultipleChoiceQuestion || IsFillBlankQuestion;

    private string McQuestion = "";
    private List<string> ShuffledOptions = new();
    private string CorrectMcAnswer = "";
    private bool McAnswered = false;
    private bool McCorrect = false;

    private string FillQuestion = "";
    private string FillCorrectAnswer = "";
    private string FillAnswer = "";
    private bool FillAnswered = false;
    private bool FillCorrect = false;

    private bool CanContinue => !IsQuestion || (McCorrect || FillCorrect);

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        wasError = false;
        errorMessage = null;

        try
        {
            if (AuthState != null)
            {
                var authState = await AuthState;
                var user = authState.User;
                currentUserId = user.GetID() ?? 0;
            }

            var courseResult = await CourseService.GetCourses();
            if (courseResult.HasError)
            {
                HandleError(courseResult.ErrorMessage);
                return;
            }

            var allCourses = courseResult.Value ?? new List<Course>();
            var thisCourse = allCourses.FirstOrDefault(c => c.Id == CourseId);

            if (thisCourse == null)
            {
                errorMessage = "Course not found.";
                isLoading = false;
                return;
            }

            totalSteps = thisCourse.TotalSteps;

            if (totalSteps == 0)
            {
                isLoading = false;
                return; 
            }

            if (currentUserId > 0)
            {
                var progressResult = await CourseService.GetCourseProgressAsync(currentUserId, CourseId);
                if (!progressResult.HasError) savedProgress = progressResult.Value;
            }

            var stepResult = await StepService.GetLearningStepAsync(CourseId, StepOrder);
            
            if (stepResult.HasError)
            {
                HandleError(stepResult.ErrorMessage);
                return;
            }

            if (stepResult.Value == null)
            {
                errorMessage = $"Step {StepOrder} content not found.";
                isLoading = false;
                return;
            }

            currentStep = stepResult.Value;
            if (currentStep?.Content != null) ParseQuestion(currentStep.Content);

            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            wasError = true;
            errorMessage = "Unexpected error loading course.";
            isLoading = false;
        }
    }

    private void HandleError(string error)
    {
        if (error == "NO_CONNECTION")
        {
            var returnUrl = Uri.EscapeDataString(NavManager.Uri);
            NavManager.NavigateTo($"/no-connection?returnUrl={returnUrl}");
        }
        else
        {
            errorMessage = error;
            isLoading = false;
        }
    }

    private void ParseQuestion(string content)
    {
        McAnswered = false; McCorrect = false;
        FillAnswered = false; FillCorrect = false; FillAnswer = "";

        if (IsMultipleChoiceQuestion)
        {
            var parts = content.Split('|');
            if(parts.Length > 1) {
                McQuestion = parts[0];
                CorrectMcAnswer = parts[1];
                ShuffledOptions = parts.Skip(1).OrderBy(x => Guid.NewGuid()).ToList();
            }
        }
        else if (IsFillBlankQuestion)
        {
            var parts = content.Split('|');
            if(parts.Length > 1) {
                FillQuestion = parts[0];
                FillCorrectAnswer = parts[1];
            }
        }
    }

    private void SelectMcOption(string option) { McAnswered = true; McCorrect = option == CorrectMcAnswer; }
    
    private void CheckFillAnswer() {
        FillAnswered = true;
        FillCorrect = string.Equals(FillAnswer.Trim(), FillCorrectAnswer.Trim(), StringComparison.OrdinalIgnoreCase);
    }

    private void GoPrevious() { if (StepOrder > 1) NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder - 1}"); }

    private async Task GoNext()
    {
        if (StepOrder >= totalSteps) { await FinishCourse(); return; }

        if (currentUserId > 0 && (StepOrder + 1) > savedProgress)
        {
            await CourseService.UpdateCourseProgressAsync(currentUserId, CourseId, StepOrder + 1);
        }
        NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder + 1}");
    }

    private async Task FinishCourse()
    {
        if (currentUserId > 0) await CourseService.UpdateCourseProgressAsync(currentUserId, CourseId, totalSteps + 1);
        NavManager.NavigateTo("/");
    }

    private string GetYouTubeEmbedUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url)) return "";
        if (url.Contains("watch?v=")) return url.Replace("watch?v=", "embed/");
        if (url.Contains("youtu.be")) return $"https://www.youtube.com/embed/{url.Split('/').Last()}";
        return url;
    }

    private void GoToEditStep() => NavManager.NavigateTo($"/courses/{CourseId}/steps/{StepOrder}/edit");
}