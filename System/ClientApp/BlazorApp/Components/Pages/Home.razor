@page "/all-courses"
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Services
@using BlazorApp.Entities
@using BlazorApp.Utils
@using System.Security.Claims
@inject AuthenticationStateProvider AuthProvider
@inject IAuthService AuthService
@inject NavigationManager NavManager
@inject ICourseService CourseService

<PageTitle>All Courses</PageTitle>

<AuthorizeView>
    <Authorized Context="context">

        <h2 class="fw-bolder text-secondary mb-4">All Courses</h2>

        <div class="d-flex justify-content-end gap-2 mb-4">
            @if (UserIsTeacherOrAdmin(context) && Utils.AuthUtils.ConvertFromClaim(context.User.Claims.First(c => c.Type == "Role").Value).Contains("teacher"))
            {
                <button class="btn btn-primary" @onclick='() => NavManager.NavigateTo("create-draft")'>
                    <i class="fas fa-plus me-2"></i> Create Draft
                </button>
            }
            @if (Utils.AuthUtils.ConvertFromClaim(context.User.Claims.FirstOrDefault(c => c.Type == "Role")?.Value ?? "").Contains("admin"))
            {
                <button class="btn btn-warning" @onclick='() => NavManager.NavigateTo("approve-draft")'>
                    <i class="fas fa-clipboard-check me-2"></i> Waiting Drafts
                </button>
            }
        </div>

        @if (courses != null && courses.Any())
        {
            <div class="row g-3 mb-5">
                <div class="col-md-8">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0 text-muted">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 ps-0" 
                               placeholder="Search catalog..." 
                               @bind="searchQuery" 
                               @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select shadow-sm" @bind="selectedCategory">
                        <option value="">All Categories</option>
                        @foreach (var cat in uniqueCategories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
            </div>
        }

        @if (courses == null || isLoading)
        {
            <div class="d-flex justify-content-center align-items-center" style="height:40vh;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        }
        else if (loadError)
        {
            <div class="alert alert-danger">Failed to load courses.</div>
        }
        else if (!courses.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <p class="text-muted fs-4">No courses available yet.</p>
            </div>
        }
        else if (!FilteredCourses.Any()) 
        {
            <div class="text-center py-5">
                <h5 class="text-muted">No courses match your search.</h5>
                <button class="btn btn-link" @onclick="ResetFilters">Clear Filters</button>
            </div>
        }
        else
        {
            @foreach (var group in FilteredCourses.OrderBy(c => c.Category).ThenBy(c => c.Id).GroupBy(c => c.Category))
            {
                <h5 class="fw-bolder text-secondary text-uppercase mt-4 mb-3 ps-1" style="letter-spacing:0.5px">
                    @group.Key
                </h5>

                <div class="row g-3">
                    @foreach (var course in group)
                    {
                        <div class="col-md-6 col-lg-4">

                            <div class="card card-course h-100 text-center bg-white @CourseDisplayUtils.GetBorderClass(course.Category)"
                                 style="--course-color: var(--game-gray);">

                                @if (UserIsTeacherOrAdmin(context))
                                {
                                    <button class="btn btn-edit-card position-absolute"
                                            style="top: 8px; right: 8px; z-index: 10;" 
                                            @onclick:stopPropagation="true"
                                            @onclick="() => OpenEditModal(course)">
                                        <i class="fas fa-pen fa-sm"></i>
                                    </button>
                                }

                                <div class="w-100 @CourseDisplayUtils.GetBgClass(course.Category)" style="height: 6px;"></div>

                                <div class="p-4 d-flex flex-column align-items-center justify-content-center flex-grow-1"
                                     @onclick="() => OpenCourse(course)"
                                     style="cursor: pointer;">

                                    <i class="@CourseDisplayUtils.GetIconClass(course.Category) fa-3x mb-4 @CourseDisplayUtils.GetTextClass(course.Category)"></i>

                                    <h5 class="fw-bolder text-dark mb-1">@course.Title</h5>

                                    <small class="text-muted fw-bold text-uppercase mt-2"
                                           style="font-size: 0.75rem; letter-spacing: 1px;">
                                        @course.Description
                                        @if (!string.IsNullOrEmpty(course.Language))
                                        {
                                            <span class="mx-1">• @course.Language</span>
                                        }
                                    </small>

                                    @{
                                        int saved = GetSavedStep(course.Id);
                                        int total = course.TotalSteps;
                                        double pct = (total > 0) ? ((double)(saved - 1) / total * 100) : 0;
                                    }
                                    
                                    <div class="w-100 mt-3">
                                        @if (saved > total && total > 0)
                                        {
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2 rounded-pill">
                                                <i class="fas fa-check me-1"></i> Completed
                                            </span>
                                        }
                                        else if (saved > 1)
                                        {
                                            <div class="d-flex align-items-center w-100">
                                                <div class="progress flex-grow-1 rounded-pill" style="height: 10px;">
                                                    <div class="progress-bar bg-primary rounded-pill" role="progressbar" style="width: @pct%"></div>
                                                </div>
                                                <span class="ms-2 small fw-bold text-primary">@Math.Round(pct)%</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-secondary border px-3 py-2 rounded-pill">
                                                Start
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }

        @if (isModalOpen)
        {
            <div class="modal fade show" style="display:block; background-color:rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content p-3">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Course</h5>
                            <button type="button" class="btn-close" @onclick="CloseModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Title</label>
                                <input class="form-control" @bind="editModel.Title" @bind:event="oninput" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Description</label>
                                <textarea class="form-control" style="min-height:80px;" @bind="editModel.Description" @bind:event="oninput"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Category</label>
                                <input class="form-control" @bind="editModel.Category" @bind:event="oninput" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Language</label>
                                <input class="form-control" @bind="editModel.Language" @bind:event="oninput" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                            <button class="btn btn-primary px-4 @(wasSavingError ? "btn-error" : "")"
                                    disabled="@(!IsDirty || isSaving)" @onclick="SaveChanges">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

    </Authorized>

    <NotAuthorized>
        <p>You must be logged in to view courses.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Course> courses = new();
    private Dictionary<int, int> courseProgressMap = new();
    private int currentUserId = 0;
    private bool isModalOpen = false;
    private bool isSaving = false;
    private bool wasSavingError = false;
    private bool loadError = false;
    private bool isLoading = true;

    private Course editModel = new();
    private Course originalModel = new();

    private string searchQuery = "";
    private string selectedCategory = "";
    private List<string> uniqueCategories = new();

    private IEnumerable<Course> FilteredCourses => courses
        .Where(c => string.IsNullOrEmpty(searchQuery) 
                    || (c.Title ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(c => string.IsNullOrEmpty(selectedCategory) 
                    || c.Category == selectedCategory);

    private bool IsDirty =>
        editModel != null && originalModel != null &&
        (editModel.Title != originalModel.Title ||
        editModel.Description != originalModel.Description ||
        editModel.Category != originalModel.Category ||
        editModel.Language != originalModel.Language);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var idClaim = user.FindFirst("Id") ?? user.FindFirst(ClaimTypes.NameIdentifier);

        if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
        {
            currentUserId = uid;
        }

        try
        {
            courses = await CourseService.GetCourses();

            if (courses != null)
            {
                uniqueCategories = courses
                    .Select(c => c.Category)
                    .Where(c => !string.IsNullOrEmpty(c))
                    .Select(c => c!)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList();
            }

            if (currentUserId > 0 && courses != null && courses.Any())
            {
                foreach (var course in courses)
                {
                    int step = await CourseService.GetCourseProgressAsync(currentUserId, course.Id);
                    if (courseProgressMap.ContainsKey(course.Id))
                        courseProgressMap[course.Id] = step;
                    else
                        courseProgressMap.Add(course.Id, step);
                }
            }
        }
        catch
        {
            loadError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetFilters()
    {
        searchQuery = "";
        selectedCategory = "";
    }

    private bool UserIsTeacherOrAdmin(AuthenticationState context)
    {
        var claim = context.User.Claims.FirstOrDefault(c => c.Type == "Role");
        if (claim is null) return false;
        var roles = Utils.AuthUtils.ConvertFromClaim(claim.Value);
        return roles.Contains("teacher") || roles.Contains("admin");
    }

    private int GetSavedStep(int courseId)
    {
        return courseProgressMap.ContainsKey(courseId) ? courseProgressMap[courseId] : 1;
    }

    private void OpenCourse(Course course)
    {
        int saved = GetSavedStep(course.Id);
        int stepToOpen = (saved > course.TotalSteps) ? 1 : saved;
        NavManager.NavigateTo($"/courses/{course.Id}/steps/{stepToOpen}");
    }

    private void OpenEditModal(Course course)
    {
        originalModel = new Course
        {
            Id = course.Id,
            Title = course.Title,
            Description = course.Description,
            Category = course.Category,
            Language = course.Language
        };

        editModel = new Course
        {
            Id = course.Id,
            Title = course.Title,
            Description = course.Description,
            Category = course.Category,
            Language = course.Language
        };

        wasSavingError = false;
        isModalOpen = true;
    }

    private void CloseModal() => isModalOpen = false;

    private async Task SaveChanges()
    {
        if (!IsDirty) return;
        isSaving = true;
        try
        {
            await CourseService.UpdateCourse(editModel.Id, editModel);
            wasSavingError = false;
            originalModel = new Course
            {
                Id = editModel.Id,
                Title = editModel.Title,
                Description = editModel.Description,
                Category = editModel.Category,
                Language = editModel.Language
            };
            courses = await CourseService.GetCourses();
            
             uniqueCategories = courses
                    .Select(c => c.Category)
                    .Where(c => !string.IsNullOrEmpty(c))
                    .Select(c => c!)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList();

            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            wasSavingError = true;
        }
        finally
        {
            isSaving = false;
        }
    }
}