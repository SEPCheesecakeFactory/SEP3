@page "/"
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Services
@inject AuthenticationStateProvider AuthProvider
@inject IAuthService AuthService
@inject NavigationManager NavManager

@using BlazorApp.Entities
@inject ICourseService CourseService

<PageTitle>Home</PageTitle>

<AuthorizeView>
    <Authorized Context="context">

        <!-- DEBUG: show current roles -->
        <p>
            Current roles:
            @string.Join(", ", context.User.Claims
                .Where(c => c.Type == "Role")
                .Select(c => c.Value))
        </p>

        <h2 class="fw-bolder text-secondary mb-5">Course Dashboard</h2>

        @if (courses == null)
        {
            <LoadingSpinner />
        }
        else if (!courses.Any())
        {
            <p class="text-muted fs-4 mt-5">No courses available.</p>
        }
        else
        {
            @foreach (var group in courses.GroupBy(c => c.Category))
            {
                <h5 class="fw-bolder text-secondary text-uppercase mt-5 mb-3 ps-1"
                    style="letter-spacing:0.5px">
                    @group.Key
                </h5>

                <div class="row g-3">
                    @foreach (var course in group)
                    {
                        <div class="col-md-6 col-lg-4">

                            <div class="card card-course h-100 text-center bg-white @GetBorderClass(course.Category ?? "")"
                                 style="--course-color: var(--game-gray);">

                                <!-- EDIT ICON (teacher/admin only) -->
                                @if (UserIsTeacherOrAdmin(context))
                                {
                                    <button class="btn btn-light border position-absolute"

                                            style="top: 5px; right: 5px; border-radius: 5px;"
                                            @onclick:stopPropagation="true"
                                            @onclick="() => OpenEditModal(course)">
                                        <i class="fas fa-pen fa-sm"></i>
                                    </button>
                                }

                                <!-- Color strip -->
                                <div class="w-100 @GetBgClass(course.Category ?? "")" style="height: 10px;"></div>

                                <!-- CARD CLICK ONLY OPENS COURSE (NOT EDIT) -->
                                <div class="p-4 d-flex flex-column align-items-center justify-content-center flex-grow-1"
                                     @onclick="() => OpenCourse(course)">

                                    <i class="@GetIconClass(course.Category ?? "") fa-3x mb-4 @GetTextClass(course.Category ?? "")"></i>

                                    <h5 class="fw-bolder text-dark mb-1">@course.Title</h5>

                                    <small class="text-muted fw-bold text-uppercase mt-2"
                                           style="font-size: 0.75rem; letter-spacing: 1px;">
                                        @course.Description
                                        @if (!string.IsNullOrEmpty(course.Language))
                                        {
                                            <span class="mx-1">• @course.Language</span>
                                        }
                                    </small>
                                </div>
                            </div>

                        </div>
                    }
                </div>
            }
        }

        <!-- MODAL for Editing -->
        @if (isModalOpen)
        {
            <div class="modal fade show"
                 style="display:block; background-color:rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content p-3">

                        <div class="modal-header">
                            <h5 class="modal-title">Edit Course</h5>
                            <button type="button" class="btn-close" @onclick="CloseModal"></button>
                        </div>

                        <div class="modal-body">

                            <div class="mb-3">
                                <label class="form-label">Title</label>
                                <input class="form-control"
                                       @bind="editModel.Title"
                                       @bind:event="oninput" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control"
                                          @bind="editModel.Description"
                                          @bind:event="oninput"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input class="form-control"
                                       @bind="editModel.Category"
                                       @bind:event="oninput" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Language</label>
                                <input class="form-control"
                                       @bind="editModel.Language"
                                       @bind:event="oninput" />
                            </div>

                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                            <button class="btn btn-primary" @onclick="SaveChanges">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        }

    </Authorized>

    <NotAuthorized>
        <p>You must be logged in to view courses.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Course> courses = new();
    private bool isModalOpen = false;
    private Course editModel = new();

    protected override async Task OnInitializedAsync()
    {
        courses = await CourseService.GetCourses();
    }

    private bool UserIsTeacherOrAdmin(AuthenticationState context)
    {
        var claim = context.User.Claims.FirstOrDefault(c => c.Type == "Role");
        if (claim is null) return false;

        var roles = Utils.AuthUtils.ConvertFromClaim(claim.Value);
        return roles.Contains("teacher") || roles.Contains("admin");
    }

    private void OpenCourse(Course course)
    {
        NavManager.NavigateTo($"/courses/{course.Id}/steps/1");
    }

    private void OpenEditModal(Course course)
    {
        editModel = new Course
        {
            Id = course.Id,
            Title = course.Title,
            Description = course.Description,
            Category = course.Category,
            Language = course.Language
        };

        isModalOpen = true;
    }

    private void CloseModal() => isModalOpen = false;

    private async Task SaveChanges()
    {
        try
        {
            await CourseService.UpdateCourse(editModel.Id, editModel);

            isModalOpen = false;

            courses = await CourseService.GetCourses();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error updating course: " + ex.Message);
        }
    }

    // Styling helpers...
    private string GetBgClass(string category) => (category?.ToLower()) switch
    {
        "computer science" => "bg-blue-100",
        "math" => "bg-purple-100",
        "history" => "bg-yellow-100",
        "languages" => "bg-red-100",
        "science" => "bg-green-100",
        _ => "bg-blue-100"
    };

    private string GetTextClass(string category) => (category?.ToLower()) switch
    {
        "computer science" => "text-blue-600",
        "math" => "text-purple-600",
        "history" => "text-yellow-600",
        "languages" => "text-red-600",
        "science" => "text-green-600",
        _ => "text-blue-600"
    };

    private string GetBorderClass(string category) => (category?.ToLower()) switch
    {
        "computer science" => "border-blue-200",
        "math" => "border-purple-200",
        "history" => "border-yellow-200",
        "languages" => "border-red-200",
        "science" => "border-green-200",
        _ => "border-blue-200"
    };

    private string GetIconClass(string category) => (category?.ToLower()) switch
    {
        "computer science" => "fa-brands fa-git-alt",
        "software engineering" => "fa-brands fa-git-alt",
        "math" => "fas fa-calculator",
        "history" => "fas fa-landmark",
        "languages" => "fas fa-language",
        "science" => "fas fa-flask",
        _ => "fas fa-book"
    };
}
