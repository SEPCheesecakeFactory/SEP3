@page "/all-courses"
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Services
@using BlazorApp.Entities
@using BlazorApp.Utils
@using System.Security.Claims
@using BlazorApp.Components
@inject AuthenticationStateProvider AuthProvider
@inject IAuthService AuthService
@inject NavigationManager NavManager
@inject ICourseService CourseService

<PageTitle>All Courses</PageTitle>

<AuthorizeView>
    <Authorized Context="context">
        <h2 class="fw-bolder text-secondary mb-4 fade-in">All Courses</h2>

        <div class="d-flex justify-content-end gap-2 mb-4 fade-in">
            @if (context.User.IsTeacher())
            {
                <button class="btn btn-primary" @onclick='() => NavManager.NavigateTo("create-draft")'>
                    <i class="fas fa-plus me-2"></i> Create Draft
                </button>
            }
            @if (context.User.IsAdmin())
            {
                <button class="btn btn-warning" @onclick='() => NavManager.NavigateTo("approve-draft")'>
                    <i class="fas fa-clipboard-check me-2"></i> Waiting Drafts
                </button>
            }
        </div>

        @if (courses != null && courses.Any())
        {
            <div class="fade-in" style="animation-delay: 0.1s;">
                <CourseFilter @bind-SearchQuery="searchQuery" @bind-SelectedCategory="selectedCategory"
                    UniqueCategories="uniqueCategories" />
                <div class="mb-5"></div>
            </div>
        }

        @if (courses == null || isLoading)
        {
            <div class="d-flex justify-content-center align-items-center" style="height:40vh;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        }
        else if (loadError)
        {
            <div class="alert alert-danger fade-in">Failed to load courses.</div>
        }
        else if (!courses.Any())
        {
            <div class="text-center py-5 fade-in">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <p class="text-muted fs-4">No courses available yet.</p>
            </div>
        }
        else if (!FilteredCourses.Any())
        {
            <div class="text-center py-5 fade-in">
                <h5 class="text-muted">No courses match your search.</h5>
                <button class="btn btn-link" @onclick="ResetFilters">Clear Filters</button>
            </div>
        }
        else
        {
            <div class="fade-in" style="animation-delay: 0.2s;">
                @foreach (var group in FilteredCourses.OrderBy(c => c.Category).ThenBy(c => c.Id).GroupBy(c => c.Category))
                {
                    <h5 class="fw-bolder text-secondary text-uppercase mt-4 mb-3 ps-1" style="letter-spacing:0.5px">
                        @group.Key
                    </h5>

                    <div class="row g-3">
                        @foreach (var course in group)
                        {
                            <CourseCard Course="course" OnOpen="OpenCourse" OnEdit="OpenEditModal"
                                ProgressStep="GetSavedStep(course.Id)" />
                        }
                    </div>
                }
            </div>
        }

        <CourseEditModal Show="isModalOpen" CourseToEdit="editModel" OriginalCourse="originalModel" IsSaving="isSaving"
            WasError="wasSavingError" OnClose="CloseModal" OnSave="SaveChanges" />

    </Authorized>

    <NotAuthorized>
        <div class="text-center py-5 my-5 border rounded-3 bg-light fade-in">
            <i class="fas fa-th-list fa-3x text-primary mb-3"></i>
            <h2 class="fw-bold text-dark">Welcome to Learnify!</h2>
            <p class="lead text-muted mb-4">Please log in to view all courses.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Course> courses = new();
    private Dictionary<int, int> courseProgressMap = new();
    private int currentUserId = 0;
    private bool isAdmin = false;

    // UI State
    private bool isModalOpen = false;
    private bool isSaving = false;
    private bool wasSavingError = false;
    private bool loadError = false;
    private bool isLoading = true;

    // Filter State
    private string searchQuery = "";
    private string selectedCategory = "";
    private List<string> uniqueCategories = new();

    // Edit Models
    private Course editModel = new();
    private Course originalModel = new();

    private IEnumerable<Course> FilteredCourses => courses
    .Where(c => string.IsNullOrEmpty(searchQuery)
    || (c.Title ?? "").Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
    .Where(c => string.IsNullOrEmpty(selectedCategory)
    || c.Category == selectedCategory)
    .Where(c =>
    // show if ApprovedBy is strictly positive
    (c.ApprovedBy != null && c.ApprovedBy > 0) ||
    // or show if I am the author (My Drafts)
    (c.AuthorId == currentUserId) ||
    // or show if I am admin
    isAdmin
    );

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity == null || !user.Identity.IsAuthenticated)
        {
            isLoading = false;
            return;
        }

        var idClaim = user.FindFirst("Id") ?? user.FindFirst(ClaimTypes.NameIdentifier);

        if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
        {
            currentUserId = uid;
        }

        isAdmin = user.IsAdmin();

        await LoadCoursesAndProgress();
    }

    private async Task LoadCoursesAndProgress()
    {
        isLoading = true;
        loadError = false;
        
        try
    {
        var coursesResult = await CourseService.GetCourses();

        if (!coursesResult.IsSuccess)
        {
            loadError = true;
            courses = new List<Course>();
            return;
        }

        courses = coursesResult.Value;

        uniqueCategories = courses
            .Select(c => c.Category)
            .Where(c => !string.IsNullOrEmpty(c))
            .Select(c => c!)
            .Distinct()
            .OrderBy(c => c)
            .ToList();

        courseProgressMap.Clear();

        if (currentUserId > 0)
        {
            foreach (var course in courses)
            {
                var stepResult =
                    await CourseService.GetCourseProgressAsync(currentUserId, course.Id);

                courseProgressMap[course.Id] =
                    stepResult.IsSuccess ? stepResult.Value : 1;
            }
        }
    }
    catch
    {
        loadError = true;
        courses = new List<Course>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetFilters()
    {
        searchQuery = "";
        selectedCategory = "";
    }

    private int GetSavedStep(int courseId)
    {
        return courseProgressMap.ContainsKey(courseId) ? courseProgressMap[courseId] : 1;
    }

    private void OpenCourse(Course course)
    {
        int saved = GetSavedStep(course.Id);
        int stepToOpen = (saved > course.TotalSteps) ? 1 : saved;
        NavManager.NavigateTo($"/courses/{course.Id}/steps/{stepToOpen}");
    }

    private void OpenEditModal(Course course)
    {
        originalModel = new Course
        {
            Id = course.Id,
            Title = course.Title,
            Description = course.Description,
            Category = course.Category,
            Language = course.Language,
            TotalSteps = course.TotalSteps,
            AuthorId = course.AuthorId,
            ApprovedBy = course.ApprovedBy
        };

        editModel = new Course
        {
            Id = course.Id,
            Title = course.Title,
            Description = course.Description,
            Category = course.Category,
            Language = course.Language,
            TotalSteps = course.TotalSteps,
            AuthorId = course.AuthorId,
            ApprovedBy = course.ApprovedBy
        };

        wasSavingError = false;
        isModalOpen = true;
    }

    private void CloseModal() => isModalOpen = false;

    private async Task SaveChanges()
    {
        isSaving = true;
        try
        {
            await CourseService.UpdateCourse(editModel.Id, editModel);
            wasSavingError = false;

            CloseModal();
            await LoadCoursesAndProgress();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            wasSavingError = true;
        }
        finally
        {
            isSaving = false;
        }
    }
}