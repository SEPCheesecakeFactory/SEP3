@page "/"
@using BlazorApp.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorApp.Services
@using BlazorApp.Entities
@using BlazorApp.Utils
@using System.Security.Claims
@inject AuthenticationStateProvider AuthProvider
@inject IAuthService AuthService
@inject NavigationManager NavManager
@inject ICourseService CourseService

<PageTitle>My Courses</PageTitle>

<AuthorizeView>
    <Authorized>
        <h2 class="fw-bolder text-secondary mb-5">My Courses</h2>

        @if (courses == null || isLoading)
        {
            <div class="d-flex justify-content-center align-items-center" style="height:40vh;">
                <LoadingSpinner />
            </div>
        }
        else if (loadError)
        {
            <div class="alert alert-danger">Failed to load courses.</div>
        }
        else if (!courses.Any())
        {
            <div class="alert alert-info">You are not enrolled in any courses yet. Browse all courses to get started!</div>
            <button class="btn btn-primary" @onclick='() => NavManager.NavigateTo("all-courses")'>Browse Courses</button>
        }
        else
        {
            @foreach (var group in courses.OrderBy(c => c.Category).ThenBy(c => c.Id).GroupBy(c => c.Category))
            {
                <h5 class="fw-bolder text-secondary text-uppercase mt-5 mb-3 ps-1" style="letter-spacing:0.5px">
                    @group.Key
                </h5>

                <div class="row g-3">
                    @foreach (var course in group)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="card card-course h-100 text-center bg-white @CourseDisplayUtils.GetBorderClass(course.Category)"
                                style="--course-color: var(--game-gray);" @onclick="() => OpenCourse(course)">

                                <div class="w-100 @CourseDisplayUtils.GetBgClass(course.Category)" style="height: 10px;"></div>

                                <div class="p-4 d-flex flex-column align-items-center justify-content-center flex-grow-1">
                                    <i class="@CourseDisplayUtils.GetIconClass(course.Category) fa-3x mb-4 @CourseDisplayUtils.GetTextClass(course.Category)"></i>

                                    <h5 class="fw-bolder text-dark mb-1">@course.Title</h5>

                                    <small class="text-muted fw-bold text-uppercase mt-2"
                                        style="font-size: 0.75rem; letter-spacing: 1px;">
                                        @course.Description
                                        @if (!string.IsNullOrEmpty(course.Language))
                                        {
                                            <span class="mx-1">â€¢ @course.Language</span>
                                        }
                                    </small>
                                    @{
                                        int saved = GetSavedStep(course.Id);
                                        int total = course.TotalSteps;
                                        double completedSteps = Math.Max(0, saved - 1);
                                        double pct = (total > 0) ? (completedSteps / total * 100) : 0;
                                    }

                                    @if (saved > total && total > 0)
                                    {
                                        <div class="mt-3 badge bg-success text-white border border-success">
                                            COMPLETED <i class="fas fa-check ms-1"></i>
                                        </div>
                                    }
                                    else if (saved > 1)
                                    {
                                        <div class="mt-3 badge bg-info text-dark bg-opacity-10 border border-info">
                                            RESUME: @Math.Round(pct)%
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mt-3 badge bg-light text-secondary border">
                                            START
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </Authorized>

    <NotAuthorized>
        <p>You must be logged in to view your courses.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<Course>? courses;
    private Dictionary<int, int> courseProgressMap = new();
    private int currentUserId = 0;
    private bool loadError = false;
    private bool isLoading = true;

   protected override async Task OnInitializedAsync()
{
    var authState = await AuthProvider.GetAuthenticationStateAsync();
    var user = authState.User;
    var idClaim = user.FindFirst("Id") ?? user.FindFirst(ClaimTypes.NameIdentifier);

    if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
    {
        currentUserId = uid;
    }

    try
    {
        var result = await CourseService.GetCourses(currentUserId);

        if (!result.IsSuccess)
        {
            if (result.ErrorMessage?.Contains("connection", StringComparison.OrdinalIgnoreCase) == true ||
                result.ErrorMessage?.Contains("refused", StringComparison.OrdinalIgnoreCase) == true ||
                result.ErrorMessage?.Contains("unreachable", StringComparison.OrdinalIgnoreCase) == true)
            {
                NavManager.NavigateTo("/no-connection");
                return;
            }

            loadError = true;
            return;
        }

        courses = result.Value ?? new List<Course>();

        // --- FETCH COURSE PROGRESS ---
        if (currentUserId > 0 && courses.Any())
        {
            foreach (var course in courses)
            {
                var progressResult = await CourseService.GetCourseProgressAsync(currentUserId, course.Id);

                if (!progressResult.IsSuccess)
                {
                    // Progress failures should NOT break the page
                    courseProgressMap[course.Id] = 1;
                }
                else
                {
                    courseProgressMap[course.Id] = progressResult.Value;
                }
            }
        }
    }
    catch
    {
        loadError = true;
    }
    finally
    {
        isLoading = false;
    }
}


    private int GetSavedStep(int courseId)
    {
        return courseProgressMap.ContainsKey(courseId) ? courseProgressMap[courseId] : 1;
    }

    private void OpenCourse(Course course)
    {
        int saved = GetSavedStep(course.Id);
        int stepToOpen = (saved > course.TotalSteps) ? 1 : saved;
        NavManager.NavigateTo($"/courses/{course.Id}/steps/{stepToOpen}");
    }
}