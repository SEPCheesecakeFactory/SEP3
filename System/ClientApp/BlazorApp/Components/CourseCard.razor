@using BlazorApp.Entities
@using BlazorApp.Utils
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthProvider

@if (Show)
{
    <div class="modal fade show" tabindex="-1" style="display:block; background-color:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content p-4 border-0 fade-in"
                 style="border-radius: 16px; border: 2px solid var(--gray-shadow); box-shadow: 0 6px 0 rgba(0,0,0,0.1);">

                <!-- HEADER -->
                <div class="modal-header border-bottom-0 pb-0">
                    <h4 class="modal-title fw-bolder text-secondary">Edit Course Info</h4>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body pt-4">
                    <!-- Title -->
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-muted text-uppercase">Title</label>
                        <input type="text" class="form-control game-input" @bind="CourseToEdit.Title"
                               placeholder="e.g. Advanced History" disabled="@(!canEditMetadata)" />
                    </div>

                    <!-- Category & Language -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">Category</label>
                            <select class="form-select game-input" @bind="CourseToEdit.Category" disabled="@(!canEditMetadata)">
                                @foreach (var cat in AvailableCategories)
                                {
                                    <option value="@cat.Name">@cat.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">Language</label>
                            <select class="form-select game-input" @bind="CourseToEdit.Language" disabled="@(!canEditMetadata)">
                                @foreach (var lang in AvailableLanguages)
                                {
                                    <option value="@lang.Code">@lang.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-muted text-uppercase">Description</label>
                        <textarea class="form-control game-input" style="min-height: 100px; resize: none;"
                                  @bind="CourseToEdit.Description" placeholder="Enter course description..."
                                  disabled="@(!canEditMetadata)"></textarea>
                    </div>

                    <!-- STEPS QUICK JUMP -->
                    <div class="mt-4 p-3 rounded-4 @(isPending ? "bg-light opacity-75" : "bg-white")"
                         style="border: 2px dashed var(--gray);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center">
                                    <h6 class="fw-bold mb-1 text-dark">Course Content</h6>
                                    @if (isPending)
                                    {
                                        <span class="badge bg-yellow-100 text-yellow-600 ms-2 mb-1" style="font-size: 0.65rem;">
                                            <i class="fas fa-clock me-1"></i> PENDING REVIEW
                                        </span>
                                    }
                                </div>
                                <p class="text-muted small mb-0">
                                    @(isPending ? "Steps are locked while waiting for approval." : "Edit individual steps and lessons.")
                                </p>
                            </div>

                            @if (!canManageSteps)
                            {
                                <button class="btn btn-sm fw-bold px-3 border-2" disabled
                                        style="background: #eee; border: 2px solid var(--gray); color: var(--secondary); cursor: not-allowed;">
                                    <i class="fas fa-lock me-2"></i> Locked
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm fw-bold px-3 shadow-sm-hover" type="button"
                                        style="background: white; border: 2px solid var(--primary); color: var(--primary); transition: all 0.2s ease;"
                                        @onclick="GoToStepEditor">
                                    <i class="fas fa-layer-group me-2"></i> Manage Steps
                                </button>
                            }
                        </div>
                    </div>

                    @if (WasError)
                    {
                        <div class="alert alert-danger mt-3 mb-0 fw-bold border-2" style="border-radius: 12px;">
                            <i class="fas fa-exclamation-circle me-2"></i> Failed to save changes.
                        </div>
                    }
                </div>

                <!-- FOOTER -->
                <div class="modal-footer border-top-0 pt-2">
                    <button type="button" class="btn btn-outline-secondary fw-bold" @onclick="Close">Cancel</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" disabled="@(IsSaving || !IsDirty || !canEditMetadata)"
                            @onclick="Save">
                        @if (IsSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public Course CourseToEdit { get; set; } = new();
    [Parameter] public Course OriginalCourse { get; set; } = new();
    [Parameter] public bool IsSaving { get; set; }
    [Parameter] public bool WasError { get; set; }
    [Parameter] public List<CourseCategory> AvailableCategories { get; set; } = new();
    [Parameter] public List<Language> AvailableLanguages { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    private const int FirstStep = 1; 
    private bool canManageSteps = false;
    private bool canEditMetadata = false;
    private bool isPending = false;

    private bool IsDirty =>
        CourseToEdit.Title != OriginalCourse.Title ||
        CourseToEdit.Description != OriginalCourse.Description ||
        CourseToEdit.Category != OriginalCourse.Category ||
        CourseToEdit.Language != OriginalCourse.Language;

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isPending = CoursePermissions.IsPendingDraft(CourseToEdit);
        canEditMetadata = CoursePermissions.CanEditMetadata(CourseToEdit, user);
        canManageSteps = CoursePermissions.CanManageSteps(CourseToEdit, user);
    }

    private Task Close() => OnClose.InvokeAsync();
    private Task Save() => OnSave.InvokeAsync();
    private void GoToStepEditor() =>
        NavManager.NavigateTo($"/courses/{CourseToEdit.Id}/steps/{FirstStep}/edit");
}